<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<title data-react-helmet="true">Rolling Update Procedure | Operator for Redis Cluster</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://ibm.github.io/operator-for-redis-cluster/rolling-update"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Rolling Update Procedure | Operator for Redis Cluster"><meta data-react-helmet="true" name="description" content="Overview"><meta data-react-helmet="true" property="og:description" content="Overview"><link data-react-helmet="true" rel="icon" href="/operator-for-redis-cluster/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://ibm.github.io/operator-for-redis-cluster/rolling-update"><link data-react-helmet="true" rel="alternate" href="https://ibm.github.io/operator-for-redis-cluster/rolling-update" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://ibm.github.io/operator-for-redis-cluster/rolling-update" hreflang="x-default"><link rel="stylesheet" href="/operator-for-redis-cluster/assets/css/styles.488c9a18.css">
<link rel="preload" href="/operator-for-redis-cluster/assets/js/runtime~main.74806389.js" as="script">
<link rel="preload" href="/operator-for-redis-cluster/assets/js/main.c195b2d0.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/operator-for-redis-cluster/"><div class="navbar__logo"><img src="/operator-for-redis-cluster/images/logo.svg" alt="Operator for Redis Cluster" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/operator-for-redis-cluster/images/logo.svg" alt="Operator for Redis Cluster" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Operator for Redis Cluster</b></a></div><div class="navbar__items navbar__items--right"><a href="https://ibm.github.io/operator-for-redis-cluster" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleChecked_a04y toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" checked="" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/">Home</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/cookbook">Cookbook</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/kubectl-plugin">Kubectl Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/configuration">Redis Server Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/scaling">Scaling Operations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/operator-for-redis-cluster/rolling-update">Rolling Update Procedure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/key-migration">Key Migration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/contributing">Contributing</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_eoK2"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_e+kA"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Rolling Update Procedure</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="overview">Overview<a class="hash-link" href="#overview" title="Direct link to heading">â€‹</a></h2><p>In production, developers aim for zero downtime when periodically deploying newer versions of their application. Per Kubernetes documentation:</p><blockquote><p>rolling updates allow Deployments&#x27; update to take place with zero downtime by incrementally updating Pods instances with new ones</p></blockquote><p>To learn more about how rolling updates work in k8s, see <a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/update/update-intro/" target="_blank" rel="noopener noreferrer">Performing a Rolling Update</a>.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="redis-cluster-upgrades">Redis cluster upgrades<a class="hash-link" href="#redis-cluster-upgrades" title="Direct link to heading">â€‹</a></h2><p>A rolling update occurs when the user applies a change to the Redis cluster pod template spec. For example, a user might update the Redis cluster pod image tag in <code>charts/node-for-redis/values.yaml</code> and run <code>helm upgrade</code>. When the Redis operator detects the pod template spec change, the following procedure takes place:</p><ol><li>Compare the number of running Redis pods with the number of pods required for the rolling update:<div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># migration pods </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> replication factor</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># required pods </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> # primaries x # migration pods</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># pods to create </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> # required pods </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> # migration pods </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> # of running pods</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div>where <code># migration pods</code> is the number of pods needed to migrate one primary and all of its replicas, <code># required pods</code> is the total number of pods required for the cluster, and <code># pods to create</code> is the number of pods to create on a single rolling update iteration.</li><li>If <code># pods to create &gt; 0</code>, create additional pods with the new pod template spec.</li><li>Separate old nodes and new nodes according to their pod spec hash annotation.</li><li>Select the old primary node to replace with one of the newly created pods.</li><li>Generate the primary to replicas mapping for the newly created pods.</li><li>Attach the new replicas to the new primary.   </li><li>Migrate slots (and by default, keys) from the old primary to the new primary. </li><li>Detach, forget, and delete the old pods.</li></ol><p>The Redis cluster rolling update procedure ensures that there is no downtime as new nodes replace old ones. However, because the migration of keys from old primaries to new ones is a time intensive operation, you may see a temporary decrease in the performance of your cluster during this process. To learn more about step 7, see <a href="/operator-for-redis-cluster/key-migration">key migration</a>.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="resource-limitations">Resource limitations<a class="hash-link" href="#resource-limitations" title="Direct link to heading">â€‹</a></h2><p>This procedure requires additional resources beyond what is normally allocated to the Redis cluster. More specifically, this procedure creates an extra <code>1 + replication factor</code> pods on each rolling update iteration, so you will need ensure that you have allocated sufficient resources. For standard configurations that allow multiple pods per node, you may need to increase memory + cpu on your existing nodes. If you have configured your cluster topology to limit one Redis pod per k8s node, you may need to increase the number of k8s nodes in your worker pool.</p><p>In the case where there are insufficient resources to schedule new Redis pods, the pods will get stuck in <code>Pending</code> state. This state is difficult to recover from because the Redis operator will continue to apply the rolling update procedure until it completes. If you find your newly created pods are in <code>Pending</code> state, increase the allocated memory + cpus.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://ibm.github.io/operator-for-redis-cluster/docs/rolling-update.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-07-13T19:32:24.000Z">7/13/2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/operator-for-redis-cluster/scaling"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Scaling Operations</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/operator-for-redis-cluster/key-migration"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Key Migration</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#redis-cluster-upgrades" class="table-of-contents__link toc-highlight">Redis cluster upgrades</a></li><li><a href="#resource-limitations" class="table-of-contents__link toc-highlight">Resource limitations</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Operator for Redis Cluster Documentation. Built with Docusaurus.</div></div></div></footer></div>
<script src="/operator-for-redis-cluster/assets/js/runtime~main.74806389.js"></script>
<script src="/operator-for-redis-cluster/assets/js/main.c195b2d0.js"></script>
</body>
</html>