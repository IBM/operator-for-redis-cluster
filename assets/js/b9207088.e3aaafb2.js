"use strict";(self.webpackChunkoperator_for_redis_cluster=self.webpackChunkoperator_for_redis_cluster||[]).push([[978],{3905:function(e,t,r){r.d(t,{Zo:function(){return u},kt:function(){return k}});var o=r(7294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,o)}return r}function a(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,o,n=function(e,t){if(null==e)return{};var r,o,n={},l=Object.keys(e);for(o=0;o<l.length;o++)r=l[o],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(o=0;o<l.length;o++)r=l[o],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var i=o.createContext({}),c=function(e){var t=o.useContext(i),r=t;return e&&(r="function"==typeof e?e(t):a(a({},t),e)),r},u=function(e){var t=c(e.components);return o.createElement(i.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},p=o.forwardRef((function(e,t){var r=e.components,n=e.mdxType,l=e.originalType,i=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(r),k=n,m=p["".concat(i,".").concat(k)]||p[k]||d[k]||l;return r?o.createElement(m,a(a({ref:t},u),{},{components:r})):o.createElement(m,a({ref:t},u))}));function k(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var l=r.length,a=new Array(l);a[0]=p;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:n,a[1]=s;for(var c=2;c<l;c++)a[c]=r[c];return o.createElement.apply(null,a)}return o.createElement.apply(null,r)}p.displayName="MDXCreateElement"},3853:function(e,t,r){r.r(t),r.d(t,{frontMatter:function(){return s},contentTitle:function(){return i},metadata:function(){return c},toc:function(){return u},default:function(){return p}});var o=r(7462),n=r(3366),l=(r(7294),r(3905)),a=["components"],s={title:"Cookbook",slug:"/cookbook"},i="Cookbook",c={unversionedId:"cookbook",id:"cookbook",title:"Cookbook",description:"Installation",source:"@site/docs/cookbook.md",sourceDirName:".",slug:"/cookbook",permalink:"/operator-for-redis-cluster/cookbook",editUrl:"https://ibm.github.io/operator-for-redis-cluster/docs/cookbook.md",tags:[],version:"current",lastUpdatedAt:1658155098,formattedLastUpdatedAt:"7/18/2022",frontMatter:{title:"Cookbook",slug:"/cookbook"},sidebar:"docs",previous:{title:"Home",permalink:"/operator-for-redis-cluster/"},next:{title:"Kubectl Plugin",permalink:"/operator-for-redis-cluster/kubectl-plugin"}},u=[{value:"Installation",id:"installation",children:[{value:"Required Dependencies",id:"required-dependencies",children:[],level:3},{value:"Recommended Dependencies",id:"recommended-dependencies",children:[],level:3},{value:"Download and build the source code",id:"download-and-build-the-source-code",children:[],level:3}],level:2},{value:"Create a Kubernetes cluster",id:"create-a-kubernetes-cluster",children:[{value:"Deploy a Redis operator",id:"deploy-a-redis-operator",children:[],level:3},{value:"Deploy a Redis cluster",id:"deploy-a-redis-cluster",children:[],level:3},{value:"Clean up your environment",id:"clean-up-your-environment",children:[],level:3}],level:2},{value:"Run end-to-end tests",id:"run-end-to-end-tests",children:[],level:2}],d={toc:u};function p(e){var t=e.components,r=(0,n.Z)(e,a);return(0,l.kt)("wrapper",(0,o.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"cookbook"},"Cookbook"),(0,l.kt)("h2",{id:"installation"},"Installation"),(0,l.kt)("p",null,"Operator for Redis Cluster is written in ",(0,l.kt)("a",{parentName:"p",href:"https://golang.org/"},"Go"),"."),(0,l.kt)("h3",{id:"required-dependencies"},"Required Dependencies"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"make")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://golang.org/doc/install"},"Go 1.17+")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://www.docker.com/"},"Docker")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://helm.sh"},"Helm 3"))),(0,l.kt)("h3",{id:"recommended-dependencies"},"Recommended Dependencies"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://kind.sigs.k8s.io/"},"Kind")," or ",(0,l.kt)("a",{parentName:"li",href:"https://github.com/kubernetes/minikube"},"Minikube")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/golangci/golangci-lint"},"golangci-lint"))),(0,l.kt)("h3",{id:"download-and-build-the-source-code"},"Download and build the source code"),(0,l.kt)("p",null,"Start by making a fork of the ",(0,l.kt)("inlineCode",{parentName:"p"},"operator-for-redis-cluster")," repository. Then, clone your forked repo:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"$ git clone git@github.com:<YOUR_USERNAME>/operator-for-redis-cluster.git\nCloning into 'operator-for-redis-cluster'...\n$ cd operator-for-redis-cluster\n")),(0,l.kt)("p",null,"Build the project:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},'$ make build\nCGO_ENABLED=0 go build -installsuffix cgo -ldflags "-w -X github.com/IBM/operator-for-redis-cluster/pkg/utils.TAG=0.3.4 -X github.com/IBM/operator-for-redis-cluster/pkg/utils.COMMIT=81c58d3bb6e713679637d9971fc8f795ca5a3e2f -X github.com/IBM/operator-for-redis-cluster/pkg/utils.OPERATOR_VERSION= -X github.com/IBM/operator-for-redis-cluster/pkg/utils.REDIS_VERSION= -X github.com/IBM/operator-for-redis-cluster/pkg/utils.BUILDTIME=2021-10-21/12:44:33 -s" -o bin/operator ./cmd/operator\nCGO_ENABLED=0 go build -installsuffix cgo -ldflags "-w -X github.com/IBM/operator-for-redis-cluster/pkg/utils.TAG=0.3.4 -X github.com/IBM/operator-for-redis-cluster/pkg/utils.COMMIT=81c58d3bb6e713679637d9971fc8f795ca5a3e2f -X github.com/IBM/operator-for-redis-cluster/pkg/utils.OPERATOR_VERSION= -X github.com/IBM/operator-for-redis-cluster/pkg/utils.REDIS_VERSION= -X github.com/IBM/operator-for-redis-cluster/pkg/utils.BUILDTIME=2021-10-21/12:44:35 -s" -o bin/node ./cmd/node\nCGO_ENABLED=0 go build -installsuffix cgo -ldflags "-w -X github.com/IBM/operator-for-redis-cluster/pkg/utils.TAG=0.3.4 -X github.com/IBM/operator-for-redis-cluster/pkg/utils.COMMIT=81c58d3bb6e713679637d9971fc8f795ca5a3e2f -X github.com/IBM/operator-for-redis-cluster/pkg/utils.OPERATOR_VERSION= -X github.com/IBM/operator-for-redis-cluster/pkg/utils.REDIS_VERSION= -X github.com/IBM/operator-for-redis-cluster/pkg/utils.BUILDTIME=2021-10-21/12:44:37 -s" -o bin/metrics ./cmd/metrics\n')),(0,l.kt)("p",null,"Run the test suite to make sure everything works:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"$ make test\n./go.test.sh\nok      github.com/IBM/operator-for-redis-cluster/pkg/controller    5.162s  coverage: 33.1% of statements\nok      github.com/IBM/operator-for-redis-cluster/pkg/controller/clustering 0.711s  coverage: 75.6% of statements\nok      github.com/IBM/operator-for-redis-cluster/pkg/controller/pod    1.726s  coverage: 40.0% of statements\nok      github.com/IBM/operator-for-redis-cluster/pkg/controller/sanitycheck    0.631s  coverage: 21.5% of statements\nok      github.com/IBM/operator-for-redis-cluster/pkg/garbagecollector  1.740s  coverage: 75.0% of statements\nok      github.com/IBM/operator-for-redis-cluster/pkg/redis 0.728s  coverage: 22.4% of statements\nok      github.com/IBM/operator-for-redis-cluster/pkg/redis/fake    0.148s  coverage: 85.8% of statements\nok      github.com/IBM/operator-for-redis-cluster/pkg/redisnode 1.924s  coverage: 43.4% of statements\n")),(0,l.kt)("p",null,"Install the kubectl Redis cluster plugin (more info ",(0,l.kt)("a",{parentName:"p",href:"/operator-for-redis-cluster/kubectl-plugin"},"here"),")"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"$ make plugin\n")),(0,l.kt)("h2",{id:"create-a-kubernetes-cluster"},"Create a Kubernetes cluster"),(0,l.kt)("p",null,"To run the Redis operator, you need to have a running Kubernetes cluster. You can use local k8s cluster frameworks such as ",(0,l.kt)("inlineCode",{parentName:"p"},"kind")," or ",(0,l.kt)("inlineCode",{parentName:"p"},"minikube"),". Use the following guide to install a ",(0,l.kt)("inlineCode",{parentName:"p"},"kind")," cluster similar to what we use in our e2e tests."),(0,l.kt)("p",null,"From the project root directory, create your kind cluster using the e2e test configuration:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"$ kind create cluster --config ./test/e2e/kind_config.yml\n")),(0,l.kt)("p",null,"Build the required docker images:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"make container PREFIX= TAG=latest\n")),(0,l.kt)("p",null,"Once the kind cluster is up and running, load the images into the kind cluster:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"$ kind load docker-image operator-for-redis:latest\n$ kind load docker-image node-for-redis:latest\n$ kind load docker-image metrics-for-redis:latest\n")),(0,l.kt)("h3",{id:"deploy-a-redis-operator"},"Deploy a Redis operator"),(0,l.kt)("p",null,"Install the ",(0,l.kt)("inlineCode",{parentName:"p"},"operator-for-redis")," Helm chart:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"$ helm install op charts/operator-for-redis --wait --set image.repository=operator-for-redis --set image.tag=latest\nNAME: op\nLAST DEPLOYED: Thu Oct 21 15:11:51 2021\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\n")),(0,l.kt)("p",null,"Confirm that the operator is running properly:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"$ kubectl get pods\nNAME                                     READY   STATUS    RESTARTS   AGE\nop-operator-for-redis-64dbfb4b59-xjttw   1/1     Running   0          31s\n")),(0,l.kt)("h3",{id:"deploy-a-redis-cluster"},"Deploy a Redis cluster"),(0,l.kt)("p",null,"Install the ",(0,l.kt)("inlineCode",{parentName:"p"},"node-for-redis")," Helm chart:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"$ helm install --wait cluster charts/node-for-redis --set image.repository=node-for-redis --set image.tag=latest\nNAME: cluster\nLAST DEPLOYED: Thu Oct 21 15:12:05 2021\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\n")),(0,l.kt)("p",null,"Check the cluster status:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"$ kubectl rc\n  POD NAME                                        IP           NODE        ID                                        ZONE   USED MEMORY  MAX MEMORY  KEYS  SLOTS\n  + rediscluster-cluster-node-for-redis-2h92v  10.244.1.89  172.18.0.3  5606ea9ab09678124a4b17de10ab92a78aac0b4d  dal13  35.55M       10.95G            5462-10923\n  | rediscluster-cluster-node-for-redis-nf24b  10.244.2.89  172.18.0.2  6840c0e5db16ebf073f57c67a6487c1c7f0d12d1  dal10  2.62M        10.95G\n  + rediscluster-cluster-node-for-redis-4h4s2  10.244.2.88  172.18.0.2  8a2f2db39b85cf059e88dc80d7c9cafefac94de0  dal10  34.63M       10.95G            10924-16383\n  | rediscluster-cluster-node-for-redis-77bt2  10.244.3.87  172.18.0.4  74582d0e0cedb458e81f1e9d4f32cdc3f5e9399b  dal12  2.60M        10.95G\n  + rediscluster-cluster-node-for-redis-dh6pt  10.244.3.86  172.18.0.4  81f5c13bec9a0545a62de08b2a309a87d29855c7  dal12  2.83M        10.95G            0-5461\n  | rediscluster-cluster-node-for-redis-jnh2h  10.244.1.88  172.18.0.3  ffae381633377414597731597518529255fd9b69  dal13  2.64M        10.95G\n\n  NAME                       NAMESPACE  PODS   OPS STATUS  REDIS STATUS  NB PRIMARY  REPLICATION  ZONE SKEW\n  cluster-node-for-redis  default    6/6/6  ClusterOK   OK            3/3         1-1/1        0/0/BALANCED\n")),(0,l.kt)("h3",{id:"clean-up-your-environment"},"Clean up your environment"),(0,l.kt)("p",null,"Delete the Redis cluster:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},'$ helm uninstall cluster\nrelease "cluster" deleted\n')),(0,l.kt)("p",null,"Delete the Redis operator:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},'$ helm uninstall op\nrelease "op" deleted\n')),(0,l.kt)("p",null,"Ensure all pods have been deleted:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"$ kubectl get pods\nNo resources found in default namespace.\n")),(0,l.kt)("h2",{id:"run-end-to-end-tests"},"Run end-to-end tests"),(0,l.kt)("p",null,"If you followed the steps for creating a ",(0,l.kt)("inlineCode",{parentName:"p"},"kind")," cluster with the e2e test configuration, then running the e2e tests is simple."),(0,l.kt)("p",null,"Build the required docker images:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"make container PREFIX=ibmcom/ TAG=local\nmake container-node PREFIX=ibmcom/ TAG=new\n")),(0,l.kt)("p",null,"Note that we need both ",(0,l.kt)("inlineCode",{parentName:"p"},"local")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"new")," image tags for a rolling update e2e test case."),(0,l.kt)("p",null,"Load the required images into the kind cluster:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"$ kind load docker-image ibmcom/operator-for-redis:local\n$ kind load docker-image ibmcom/node-for-redis:local\n$ kind load docker-image ibmcom/node-for-redis:new\n")),(0,l.kt)("p",null,"Once the kind cluster is up and running, deploy the ",(0,l.kt)("inlineCode",{parentName:"p"},"operator-for-redis")," Helm chart:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},"$ helm install op charts/operator-for-redis --wait --set image.repository=ibmcom/operator-for-redis --set image.tag=local\nNAME: op\nLAST DEPLOYED: Thu Oct 21 15:11:51 2021\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\n")),(0,l.kt)("p",null,"When the ",(0,l.kt)("inlineCode",{parentName:"p"},"operator-for-redis")," pod is up and running, you can start the e2e regression:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-console"},'$ go test -timeout 30m ./test/e2e --kubeconfig=$HOME/.kube/config --ginkgo.v --test.v\nRunning Suite: RedisCluster Suite\n=================================\nRandom Seed: 1634845111\nWill run 11 of 11 specs\n\nOct 21 15:38:31.261: INFO: KubeconfigPath-> "/Users/kscharm/.kube/config"\nOct 21 15:38:31.295: INFO: Check whether RedisCluster resource is registered...\nRedisCluster CRUD operations\n  should create a RedisCluster\n  \n...\n\nRan 11 of 11 Specs in 517.299 seconds\nSUCCESS! -- 11 Passed | 0 Failed | 0 Pending | 0 Skipped\nPASS\nok      github.com/IBM/operator-for-redis-cluster/test/e2e  517.776s\n')))}p.isMDXComponent=!0}}]);